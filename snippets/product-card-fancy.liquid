{%- comment -%}
  Reusable product card with:
  - rounded image
  - optional hover image (by media index)
  - overlay CTA (Add to cart / View options / Sold out)
  - optional Judge.me preview badge
  Pass in:
    product                (Product object)         – required
    hover_media_index      (Number, 1-based)        – optional (default 3)
    show_reviews           (Boolean)                – optional (default true)
{%- endcomment -%}

{{ 'component-rating.css' | asset_url | stylesheet_tag }}
{%- unless pcard_styles_loaded -%}
  {%- assign pcard_styles_loaded = true -%}
  <style>
    /* ===== Product Card (pcard) base styles ===== */
    .pcard {
      --pcard-radius: 12px;
      --pcard-cta-bg: #333;
      --pcard-cta-disabled: #9aa0a6;
      /* Optional safety if card is not inside a grid; remove if no need */
      --pcard-max-w: 350px;
    }
    .pcard__imgwrap {
      position: relative;
      max-width: var(--pcard-max-w);
      margin-inline: auto;
      width: 100%;
    }

    /* Fixed SQUARE box for images */
    .pcard__media {
      position: relative;
      border-radius: var(--pcard-radius);
      overflow: hidden;
      background: #f6f6f6;
      aspect-ratio: 1 / 1; /* square */
    }
    @supports not (aspect-ratio: 1) {
      .pcard__media::before {
        content: '';
        display: block;
        padding-bottom: 100%;
      }
    }

    .pcard__media .pcard__img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center; /* fill square without distortion */
      display: block;
      transition: opacity 0.25s ease;
    }
    .pcard__img--hover {
      opacity: 0;
    }
    .pcard:hover .pcard__img--hover,
    .pcard:focus-within .pcard__img--hover {
      opacity: 1;
    }
    .pcard:hover .pcard__img--default,
    .pcard:focus-within .pcard__img--default {
      opacity: 0;
    }

    .pcard__overlay {
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: 16px;
      display: grid;
      transform: translateY(8px);
      opacity: 0;
      transition: transform 0.2s ease, opacity 0.2s ease;
      product-form {
        width: 100%;
      }
    }
    .pcard:hover .pcard__overlay,
    .pcard:focus-within .pcard__overlay {
      opacity: 1;
      transform: translateY(0);
    }
    @media (max-width: 749.98px) {
      .pcard__overlay {
        opacity: 1;
        transform: none;
      }
    }

    .pcard__btn,
    .pcard__form .button {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      padding: 12px 16px;
      border-radius: var(--pcard-radius);
      background: var(--pcard-cta-bg);
      color: #fff;
      font-weight: 600;
      font-family: Roboto, sans-serif;
      font-size: 14px;
      text-decoration: none;
      --border-offset: 0; /* neutralize outer ring */
      --buttons-border-offset: 0; /* some Dawn versions use this var */
    }
    .pcard__form .button:hover,
    .pcard__form .button:focus {
      outline: none !important;
      box-shadow: none !important;
    }
    .pcard__form .button::before,
    .pcard__form .button::after {
      box-shadow: none !important;
      border: 0 !important;
    }
    .pcard__btn--disabled {
      background: var(--pcard-cta-disabled);
      cursor: not-allowed;
    }

    .pcard__body {
      text-align: center;
      padding: 8px 0 0;
    }
    .pcard__title {
      margin: 0 0 6px;
    }
    .pcard__title a {
      color: inherit;
      text-decoration: none;
      font-family: 'Roboto Condensed', 'Roboto', sans-serif;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.6;
      letter-spacing: 0px;
    }
    .pcard__title a:hover {
      text-decoration: none;
    }
    .pcard__reviews {
      margin: 6px 0;
    }
    .pcard__price {
      margin-top: 6px;
      line-height: 1.6;
      font-weight: 300;
      color: rgba(var(--color-foreground), 1);
    }
    /* ==== Rating (stars + count) ==== */
    .pcard__reviews {
      margin: 6px 0;
    }
    .pcard__rating {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .pcard__rating-stars {
      --star-size: 18px; /* ajusta tamaño a gusto */
      position: relative;
      width: calc(var(--star-size) * 5);
      height: var(--star-size);
    }
    /* capa base: contorno de 5 estrellas */
    .pcard__stars {
      position: absolute;
      inset: 0;
      background-repeat: repeat-x;
      background-size: var(--star-size) var(--star-size);
      pointer-events: none;
    }
    .pcard__stars--outline {
      background-image: url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\
      <path d="M12 2.3l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.8 6.2 20.1l1.1-6.4L2.6 9.1l6.5-.9L12 2.3z" fill="none" stroke="%23FFCB1F" stroke-width="2" stroke-linejoin="round"/>\
      </svg>');
    }
    .pcard__stars--fill {
      background-image: url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\
      <path d="M12 2.3l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.8 6.2 20.1l1.1-6.4L2.6 9.1l6.5-.9L12 2.3z" fill="%23FFCB1F" stroke="%23FFCB1F" stroke-width="2" stroke-linejoin="round"/>\
      </svg>');
      width: var(--rating-pct, 0%);
      overflow: hidden;
    }
    .pcard__count {
      font-size: 16px;
      color: rgba(0, 0, 0, 0.72);
      white-space: nowrap;
    }
  </style>
{%- endunless -%}

{%- assign prod = product -%}
{%- if prod == blank -%}{% comment %} Nothing to render {% endcomment %}{% endif -%}

{%- assign hover_idx_1_based = hover_media_index | default: 3 -%}
{%- assign idx0 = hover_idx_1_based | minus: 1 -%}
{%- assign main_media = prod.featured_media -%}
{%- assign hover_media = main_media -%}

{%- if prod.media.size > idx0 and idx0 >= 0 -%}
  {%- assign hover_media = prod.media[idx0] -%}
{%- endif -%}

{%- assign single_variant = prod.has_only_default_variant -%}
{%- assign first_av = prod.selected_or_first_available_variant -%}
{%- assign price_text = '' -%}
{%- if prod.has_only_default_variant -%}
  {%- assign price_text = first_av.price | money -%}
{%- else -%}
  {%- assign min_price_money = prod.price_min | money -%}
  {%- assign price_text = 'From ' | append: min_price_money -%}
{%- endif -%}

{%- comment -%}
  You can override the image box ratio with `image_ratio: 'square' | 'portrait' | 'landscape'`.
  Default = 'portrait' (taller than wide), which matches the reference site.
{%- endcomment -%}
{%- assign ratio = image_ratio | default: 'square' -%}
{%- case ratio -%}
  {%- when 'square' -%}
    {% assign pad = '100%' -%}
    {%- assign ar = '1 / 1' %}
  {%- when 'landscape' -%}
    {% assign pad = '66.6667%' -%}
    {%- assign ar = '3 / 2' %}
  {%- else -%}
    {% assign pad = '125%' -%}
    {%- assign ar = '4 / 5' %}
{%- endcase -%}

<div class="pcard" data-available="{{ prod.available }}">
  <div class="pcard__imgwrap">
    <a class="pcard__imglink" href="{{ prod.url }}" aria-label="{{ prod.title | escape }}">
      <div class="pcard__media">
        {%- assign main_img = main_media.preview_image | default: main_media -%}
        {%- assign hover_img = hover_media.preview_image | default: hover_media -%}
        {%- assign main_alt = main_img.alt | default: prod.title -%}
        {%- assign hover_alt = hover_img.alt | default: prod.title -%}

        {%- if main_img -%}
          {{
            main_img
            | image_url: width: 1200
            | image_tag:
              widths: '400, 800, 1200',
              sizes: '(min-width: 1200px) 25vw, (min-width: 750px) 50vw, 100vw',
              class: 'pcard__img pcard__img--default',
              loading: 'lazy',
              width: main_img.width,
              height: main_img.height,
              alt: main_alt
          }}
        {%- endif -%}

        {%- if hover_img -%}
          {{
            hover_img
            | image_url: width: 1200
            | image_tag:
              widths: '400, 800, 1200',
              sizes: '(min-width: 1200px) 25vw, (min-width: 750px) 50vw, 100vw',
              class: 'pcard__img pcard__img--hover',
              loading: 'lazy',
              width: hover_img.width,
              height: hover_img.height,
              alt: hover_alt
          }}
        {%- endif -%}
      </div>
    </a>

    <!-- Overlay CTA -->
    <div class="pcard__overlay">
      {%- if single_variant -%}
        {%- if first_av.available -%}
          {%- assign section_key = section_id | default: section.id | default: 'pcard' -%}
          {%- assign product_form_id = 'quick-add-' | append: section_key | append: '-' | append: prod.id -%}

          <product-form data-section-id="{{ section_key }}">
            {%- form 'product',
              prod,
              id: product_form_id,
              class: 'form pcard__form',
              novalidate: 'novalidate',
              data-type: 'add-to-cart-form'
            -%}
              <input
                type="hidden"
                name="id"
                value="{{ prod.selected_or_first_available_variant.id }}"
                class="product-variant-id"
                {% unless prod.selected_or_first_available_variant.available %}
                  disabled
                {% endunless %}
              >

              <button
                id="{{ product_form_id }}-submit"
                type="submit"
                name="add"
                class="quick-add__submit button button--full-width button--secondary"
                aria-live="polite"
                data-sold-out-message="true"
                {% unless prod.selected_or_first_available_variant.available %}
                  disabled
                {% endunless %}
              >
                <span>
                  {%- if prod.selected_or_first_available_variant.available -%}
                    {{ 'products.product.add_to_cart' | t }}
                  {%- else -%}
                    {{ 'products.product.sold_out' | t }}
                  {%- endif -%}
                </span>
                <span class="sold-out-message hidden">{{ 'products.product.sold_out' | t }}</span>
                {%- render 'loading-spinner' -%}
              </button>
            {%- endform -%}
          </product-form>
        {%- else -%}
          <button type="button" class="pcard__btn pcard__btn--disabled" disabled>
            {{ 'products.product.sold_out' | t }}
          </button>
        {%- endif -%}
      {%- else -%}
        {%- if prod.available -%}
          <a class="pcard__btn" href="{{ prod.url }}">
            {{ 'products.product.view_full_details' | t | default: 'View options' }}
          </a>
        {%- else -%}
          <button type="button" class="pcard__btn pcard__btn--disabled" disabled>
            {{ 'products.product.sold_out' | t }}
          </button>
        {%- endif -%}
      {%- endif -%}
    </div>
  </div>

  <div class="pcard__body">
    <h3 class="pcard__title">
      <a href="{{ prod.url }}">{{ prod.title }}</a>
    </h3>

    {% comment %} Reviews {% endcomment %}
    {%- if show_reviews != false -%}
      {%- liquid
        assign rating_obj = prod.metafields.reviews.rating.value
        assign rating_val = 0
        assign rating_max = 5
        assign reviews_count = 0

        if rating_obj
          assign rating_val = rating_obj.rating | plus: 0
          assign rating_max = rating_obj.scale_max | default: 5 | plus: 0
          assign reviews_count = prod.metafields.reviews.rating_count | default: 0 | plus: 0
        endif

        assign pct = 0
        if rating_max > 0
          assign pct = rating_val | times: 100.0 | divided_by: rating_max
        endif
      -%}

      {%- if reviews_count > 0 -%}
        <div class="pcard__reviews">
          <div class="pcard__rating" aria-label="{{ rating_val }} out of {{ rating_max }} stars">
            <span class="pcard__rating-stars" aria-hidden="true">
              <span class="pcard__stars pcard__stars--fill" style="--rating-pct: {{ pct }}%;"></span>
              <span class="pcard__stars pcard__stars--outline"></span>
            </span>
            <span class="pcard__count">
              {%- if reviews_count == 1 -%}1 review{%- else -%}{{ reviews_count }} reviews{%- endif -%}
            </span>
          </div>
        </div>
      {%- endif -%}
    {%- endif -%}

    <div class="pcard__price">
      {{ price_text }}
    </div>
  </div>
</div>

<script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
